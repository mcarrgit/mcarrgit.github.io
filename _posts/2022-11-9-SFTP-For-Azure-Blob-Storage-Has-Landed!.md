In recent news Microsoft have released a pretty significant update to Azure Blob Storage, **the support of SFTP!** This finally brings a fully managed PaaS solution for SFTP to Microsoft Azure. 

While Azure Blob Storage has previously supported secure data transfers via methods such as REST API, Azure SDKs and AzCopy - SFTP support has been a desired addition by many, as it's been a popular protocol for decades and is still in use in many organizations.

In this post we're going to look at how to get started with this new feature, and then I'll share my thoughts on the advantages and disadvantages of the offering. At the time of writing, the latest AzureRM provider (3.30.0) does not support the configuration of this feature, so we will deploy the required infrastructure via Terraform then move to the Azure Portal to enable and configure SFTP. 

When the AzureRM provider is updated, I will revisit this post and include the Terraform configuration.

# Contents

* Deploying the required infrastructure via Terraform
* Configuring SFTP in the Azure Portal
* Testing the SFTP endpoint
* Final thoughts


# Deploying the required infrastructure

To keep things simple, we will only deploy the bare minimum configuration required to get started with SFTP for Azure Blob Storage. This includes:

* A Resource Group to contain the resources
* A Storage Account with hierarchical namespaces enabled to serve as the SFTP endpoint (hierarchical namespaces are a prerequisite of enabling SFTP)
* A Storage container to upload blobs into via SFTP

The below terraform files will take care of this for us:

### providers.tf

```terraform
provider "azurerm" {
  features {}
}
```
### versions.tf

```terraform
terraform {
  required_version = ">= 1.3.4"

  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
    }
  }
}
```

### main.tf

```terraform
resource "azurerm_resource_group" "this" {
  name     = "mattcarr-sftp-rg"
  location = "australiaeast"
}

resource "azurerm_storage_account" "this" {
  name                = "mattcarrsftpstac"
  resource_group_name = azurerm_resource_group.this.name

  location                 = azurerm_resource_group.this.location
  account_tier             = "LRS"
  account_replication_type = "Standard"
  min_tls_version          = "TLS1_2"
  is_hns_enabled           = true # Enables Heirarchical Namespace. Required prerequisite of SFTP.
}

resource "azurerm_storage_container" "this" {
  name                 = "container"
  storage_account_name = azurerm_storage_account.this.name
}
```
 
Once these files have been created, Terraform plan and Terraform Apply can be used to provision the required infrastructure to your Azure subscription.

![Provision Infrastructure](/images/sftp/terraform.png)

# Configuring SFTP in the Azure Portal

### Enabling SFTP on the Storage Account

Enabling SFTP on a Storage Account is incredibly simple and can be done as following:

1. Navigate to the Storage Account and browse to **Settings** -> **SFTP** then select **Enable SFTP**

![Enable SFTP](/images/sftp/enable_sftp.png)

As mentioned earlier, you will need Heirarchical Namespaces enabled on the Storage Account before you can enable SFTP.

*Note: enabling SFTP will also enable local users, which we cover in the next section.*

### Adding local users

Of course to use SFTP, your end users and systems are going to need a means of authentication. Azure Blob Storage allows you to create local users for authentication to the SFTP endpoint. They support the two following authentication methods:

* SSH Password - Automatically generated by Azure during user creation and can be regenerated as needed
* SSH Key Pair - A public-private key pair. You can either generate one or use one already stored in Azure, or provide Azure with a public key of an existing public-private key pair.

To demonstrate the process we're going to create a local user with an SSH password that has full access to our container. We can do this by:

1. Navigating back to **Settings** -> **SFTP** and clicking **Add Local User**.

2. Specifying the username and authentication method of the user. The user can either authenticate with a generated password or an SSH key pair, but as mentioned we want to use SSH Password authentication in this example, so we select this option.

![Add Local User](/images/sftp/authentication.png)

3. Specifying which container the local user should have access to, and which permissions the local user should have. Here we'll provide access to the "container" container and allow full access, which includes Read, Write, List, Delete and Create permissions.

![Define Container Access](/images/sftp/permissions.png)

4. Azure will automatically generate a secure local user password for us, make sure you copy this password as we'll use it to test the SFTP connection in the next section. 

![Copy SSH Password](/images/sftp/password.png)

# Testing the SFTP endpoint

To connect to the SFTP endpoint we need three things:

* The SSH Password we generated earlier (or an SSH Key Pair if you chose this option instead)
* The connection string
* An SFTP Client

The connection string is in the format of:

```
<STORAGE_ACCOUNT_NAME>.<CONTAINER_NAME>.<LOCAL_USERNAME>@<STORAGE_ACCOUNT_NAME>.blob.core.windows.net
```

This can be copied from the SFTP page of the Storage account here, you'll just need to add the container name:

![Copy Connection String](/images/sftp/connectionstring.png)

So in my case, the connection string will be:

```
mattcarrsftpstac.container.mattcarr@mattcarrsftpstac.blob.core.windows.net
```

Now that we've got our username, SSH password and connection string we should have everything we need to test the service. I'm going to be using the FileZilla client to connect to my storage account.

![FileZilla connect](/images/sftp/filezilla_success.png)

Note that I have a test_file.txt in my local directory, that I'm going to upload via SFTP to confirm I have the correct access and the service is working as expected:

![FileZilla Upload](/images/sftp/filezilla2.png)

As evident in the log, there's no issues here and the file has been uploaded successfully. I can also see it from the Azure Portal:

![Blob File](/images/sftp/container_file.png)

# Final Thoughts

### The Good

SFTP for Azure Blob Storage is simple to use, easy to set-up and provides all the benefits of the shared responsibility model. You'll decrease your operations overhead in comparison to hosting your own SFTP server, and it keeps everything internal to Azure - removing the need to integrate other tools or systems to support SFTP for Azure Blob Storage.

We've been waiting a long time for an Azure SFTP PaaS offering, and this is a great start.

### The Bad

Unfortunately when using the SSH Password option there's no way to specify your own password, you have to deal with the password that Azure generates. While this may not necessarily be bad due to the fact it ensures you have a strong password - it can be inconvenient if you're looking to migrate legacy systems without having to go through a password reset process.

The lack of integration with Azure AD is another area for improvement. While local users work fine, I would prefer RBAC authentication for human users, which could bring the benefit of supporting MFA.

### The Ugly

In my opinion, what is possibly the biggest downside with this offering is the pricing model, on top of the costs associated with the underlying storage account - Microsoft are charging $0.30 USD per hour for the enabling of the SFTP endpoint on a storage account. This comes to on average $219 USD a month. If you start setting up SFTP endpoints on **multiple** storage accounts the value proposition quickly derails, and you may find fully fledged file transfer products like GoAnywhere MFT to be the more attractive option.

This cost can be minimized by using a single dedicated Storage Account for all of your SFTP requirements, but this isn't always ideal or possible depending on your environment and policies.